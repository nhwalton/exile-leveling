import{Data as s}from"./index.38363fb6.js";function h(r,e,n){r=r.trim();let t=0;do{const o=y(r,t,e,n);if(o!==null)t=o;else return!1}while(t<r.length);return!0}function y(r,e,n,t){for(const o of n){o.regex.lastIndex=e;const i=o.regex.exec(r);if(i&&i.index===e)return o.processor(i,t)?o.regex.lastIndex:null}return null}const _={kill:v,arena:m,area:x,enter:E,logout:R,waypoint:S,waypoint_get:W,portal:b,quest:L,quest_text:P,generic:$,reward_quest:T,reward_vendor:N,trial:k,ascend:D,crafting:q,dir:O},w=[{regex:/( *#.*)/g,processor:()=>!0},{regex:/[^{#]+/g,processor:(r,{step:e})=>(e.parts.push(r[0]),!0)},{regex:/\{(.+?)\}/g,processor:(r,{state:e,step:n})=>{const t=r[1].split("|"),o=_[t[0]],i=o(t,e);return typeof i=="string"?e.logger.error(i):n.parts.push(i.fragment),!0}}];function I(r,e){const t={state:e,step:{type:"fragment_step",parts:[]}};return h(r,w,t)||e.logger.error("invalid syntax"),t.step}function c(r,e){e.is_town_area&&(r.lastTownAreaId=e.id,e.has_waypoint&&r.implicitWaypoints.add(e.id)),r.currentAreaId=e.id}const a="invalid format",l="area does not exist",A="area does not have a waypoint";function v(r,e){if(r.length!=2)return a;const n=r[1],t=s.KillWaypoints[n];if(t)for(const o of t)e.implicitWaypoints.add(o);return{fragment:{type:"kill",value:n}}}function m(r,e){return r.length!=2?a:{fragment:{type:"arena",value:r[1]}}}function x(r,e){if(r.length!=2)return a;const n=s.Areas[r[1]];return n?{fragment:{type:"area",areaId:n.id}}:l}function E(r,e){if(r.length!=2)return a;const n=s.Areas[r[1]];return n?(n.connection_ids.some(t=>t==e.currentAreaId)||e.logger.warn("not connected to current area"),c(e,n),{fragment:{type:"enter",areaId:n.id}}):l}function R(r,e){if(r.length!=1)return a;const n=s.Areas[e.lastTownAreaId];return c(e,n),e.portalAreaId=null,{fragment:{type:"logout",areaId:n.id}}}function S(r,e){{if(r.length!=1&&r.length!=2)return a;if(r.length==2){const n=s.Areas[r[1]];if(!n)return l;!e.implicitWaypoints.has(n.id)&&!e.explicitWaypoints.has(n.id)&&e.logger.warn("missing waypoint");const t=s.Areas[e.currentAreaId];return t.has_waypoint||e.logger.warn(A),e.implicitWaypoints.add(t.id),e.usedWaypoints.add(n.id),c(e,n),{fragment:{type:"waypoint_use",dstAreaId:n.id,srcAreaId:t.id}}}return{fragment:{type:"waypoint"}}}}function W(r,e){if(r.length!=1)return a;const n=s.Areas[e.currentAreaId];return n?(n.has_waypoint||e.logger.warn(A),e.implicitWaypoints.has(n.id)&&e.logger.warn("waypoint already acquired"),e.explicitWaypoints.add(n.id),{fragment:{type:"waypoint_get"}}):l}function b(r,e){if(r.length!=2)return a;const n=s.Areas[e.currentAreaId];switch(r[1]){case"set":return n.is_town_area?"portal cannot be set":(e.portalAreaId=e.currentAreaId,{fragment:{type:"portal_set"}});case"use":{if(e.portalAreaId!=n.id&&!n.is_town_area&&(e.portalAreaId=n.id),!e.portalAreaId)return"portal not set";const t=s.Areas[e.portalAreaId];if(n.id==t.id){if(!n.parent_town_area_id)return"cannot use portal in this area";const o=s.Areas[n.parent_town_area_id];c(e,o),e.portalAreaId=e.currentAreaId}else if(n.id==t.parent_town_area_id)c(e,t),e.portalAreaId=null;else return"can only use portal from town or portal area";return{fragment:{type:"portal_use",dstAreaId:e.currentAreaId}}}}return a}function T(r,e){return r.length!=2?a:(s.Areas[e.currentAreaId].is_town_area||e.logger.warn("quest_reward used outside of town"),{fragment:{type:"reward_quest",item:r[1]}})}function N(r,e){return r.length!=2&&r.length!=3?a:(s.Areas[e.currentAreaId].is_town_area||e.logger.warn("reward_vendor used outside of town"),{fragment:{type:"reward_vendor",item:r[1],cost:r.length==3?r[2]:void 0}})}function $(r,e){return r.length!=2?a:{fragment:{type:"generic",value:r[1]}}}function q(r,e){if(r.length>2)return a;let n;if(r.length==1)n=s.Areas[e.currentAreaId];else if(n=s.Areas[r[1]],!n)return l;return e.craftingAreas.add(n.id),{fragment:{type:"crafting",crafting_recipes:n.crafting_recipes}}}function O(r,e){if(r.length!=2)return a;const n=Number.parseFloat(r[1]);if(Number.isNaN(n))return"dir value is not a number";let t=n%360;return t<0&&(t+=360),t%45!=0?"dir value must be in intervals of 45":{fragment:{type:"dir",dirIndex:Math.floor(t/45)}}}function L(r,e){{if(r.length<2)return a;const n=r[1],t=s.Quests[n];if(!t)return"invalid quest id";let o;if(r.length==2)o=Object.keys(t.reward_offers);else{o=[];for(let i=2;i<r.length;i++)o.push(r[i])}return{fragment:{type:"quest",questId:r[1],rewardOffers:o}}}}function P(r,e){return r.length!=2?a:{fragment:{type:"quest_text",value:r[1]}}}function k(r,e){return r.length!=1?a:{fragment:{type:"trial"}}}function D(r,e){if(r.length!=2)return a;const n="Labyrinth_Airlock";if(s.Areas[e.currentAreaId].id!=n){const i=s.Areas[n];e.logger.warn(`must be in "${i.name}"`)}const o=s.Areas[e.lastTownAreaId];return c(e,o),{fragment:{type:"ascend",version:r[1]}}}class M{constructor(){this.scopes=[],this.logs=[]}pushScope(e){this.scopes.push(e)}popScope(){this.scopes.pop()}withScope(e,n){this.pushScope(e),n(),this.popScope()}buildPrefix(){return this.scopes.length>0?`${this.scopes.join(", ")}: `:""}warn(e){this.logs.push({type:"warning",msg:`${this.buildPrefix()}${e}`})}error(e){this.logs.push({type:"error",msg:`${this.buildPrefix()}${e}`})}drain(e){for(const n of this.logs)switch(n.type){case"warning":e.warn(n.msg);break;case"error":e.error(n.msg);break;default:e.log(n.msg);break}this.logs.length=0,this.scopes.length!==0&&e.warn(`expected 0 scopes got ${this.scopes.length}, ${this.scopes.join(", ")}`)}}const d="Default";function G(r){const e=[];for(const n of r){const t=n.split(/\r\n|\r|\n/g);for(let o=0;o<t.length;o++){const i=t[o],u=/^ *#section *(.*)/g.exec(i);if(u){const g=u[1]||d;e.push({name:g,contents:`#section ${g}`});continue}e.length==0&&e.push({name:d,contents:`#section ${d}`});const f=e[e.length-1];f.contents+=`
${i}`}}return e}function Q(r){return r.map(e=>e.contents).join(`
`)}const j=[{regex:/^ *#endif/g,processor:(r,{state:e,conditionalStack:n})=>(n.pop()===void 0&&e.logger.warn("unexpected #endif"),!1)},{regex:/^ *#ifdef *(.*)/g,processor:(r,{state:e,conditionalStack:n})=>{const t=r[1];return t&&n.push(e.preprocessorDefinitions.has(t)),!1}},{regex:/.*/g,processor:(r,{state:e,section:n,conditionalStack:t})=>{if(t.length==0||t[t.length-1]){const i=I(r[0],e);i.parts.length>0&&n.steps.push(i)}return!1}}];function U(r,e){const n=[];for(const t of r){const o=t.contents.split(/\r\n|\r|\n/g),i={name:t.name,steps:[]};n.push(i),e.logger.pushScope(i.name);const p={state:e,section:i,conditionalStack:[]};for(let u=0;u<o.length;u++){const f=o[u];!f||(e.logger.pushScope(`line ${u+1}`),h(f,j,p),e.logger.popScope())}p.conditionalStack.length!=0&&e.logger.warn("expected #endif"),e.logger.popScope()}for(const t of e.explicitWaypoints)e.usedWaypoints.has(t)||e.logger.warn(`unused waypoint ${t}`);for(const t in s.Areas){const o=s.Areas[t];o.crafting_recipes.length>0&&!e.craftingAreas.has(o.id)&&e.logger.warn(`missing crafting area ${o.id}, ${o.crafting_recipes.join(", ")}`)}return e.logger.drain(console),n}function K(){return{implicitWaypoints:new Set,explicitWaypoints:new Set,usedWaypoints:new Set,craftingAreas:new Set,currentAreaId:"1_1_1",lastTownAreaId:"1_1_town",portalAreaId:null,preprocessorDefinitions:new Set,logger:new M}}export{Q as buildRouteSource,G as getRouteFiles,K as initializeRouteState,U as parseRoute};
